#!/usr/bin/env python

import os
import pwd
from os import path
import argparse

assert os.getlogin() != 'root', 'Must run as user with sudo'
assert os.getuid() == 0 and os.getgid() == 0, 'Must use sudo'

login = os.getlogin()
pwd_entry = pwd.getpwnam(login)
uid = pwd_entry[2]
gid = pwd_entry[3]

config_dir = path.normpath(path.join(path.dirname(__file__), '..'))
root_script_dirs = ['ubuntu', 'fedora']
user_script_dirs = ['homedir', 'vim']

def get_scripts(script_dirs):
    scripts = []
    for script_dir in script_dirs:
        for root, _, filenames in os.walk(path.join(config_dir, script_dir)):
            for filename in filenames:
                filename = path.join(root, filename)
                if os.access(filename, os.X_OK):
                    scripts.append(filename)
    return sorted(scripts, key=lambda filepath: path.basename(filepath))

root_scripts = get_scripts(root_script_dirs)
user_scripts = get_scripts(user_script_dirs)

parser = argparse.ArgumentParser(description='Run each setup scripts in order')
parser.add_argument('--list', '-l',
                    action='store_true', default=False,
                    help='List the setup scripts rather than run')
args = parser.parse_args()

if args.list:
    for script in root_scripts:
        print '<root>', script
    for script in user_scripts:
        print '<{}>'.format(login), script
else:
    for script in root_scripts:
        os.system(script)
    os.setgid(gid)
    os.setuid(uid)
    for script in user_scripts:
        os.system(script)
