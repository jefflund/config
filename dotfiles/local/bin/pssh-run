#!/usr/bin/env python3

"""An easier way to run pssh"""

import os
import subprocess
import argparse

def main():
    """Runs the pssh wrapper"""
    parser = argparse.ArgumentParser()
    parser.description = 'An easier way to run pssh'
    parser.add_argument('-p', '--potatoes', default='/config/potatoes/all',
                        help='host file to use')
    parser.add_argument('-n', '--name', required=True,
                        help='name of the job')
    parser.add_argument('-c', '--command', required=True,
                        help='command to run')
    args = parser.parse_args()

    basedir = os.path.join(os.getenv('HOME'), 'scratch', args.name)
    outdir = os.path.join(basedir, 'stdout')
    errdir = os.path.join(basedir, 'stderr')

    potatoes = []
    for hostfile in args.potatoes.split(';'):
        potatoes.append('-h')
        potatoes.append(hostfile)

    cmd = ['pssh']
    cmd += potatoes
    cmd += ['-o', os.path.join(basedir, 'stdout'),
            '-e', os.path.join(basedir, 'stderr'),
            '-t', '0',
            args.command.replace('##', args.name)]
    subprocess.call(cmd)


if __name__ == '__main__':
    main()
